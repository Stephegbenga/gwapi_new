<!-- create simple html5 template -->
<html>

<head>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
  <script src="https://live.zwidgets.com/js-sdk/1.1/ZohoEmbededAppSDK.min.js"></script>
  <style>
    .messageheader {
      /* make all contents stay exactly at the middle */
      display: flex;
      justify-content: center;
      align-items: center;
      /* make the header have a fixed height */
      height: 50px;
      background-color: #07385d;
      color: #fff;
      float: left;
      width: 200px;

    }

    .headerli {
      /* make it stand at the middle */
      display: flex;
      position: fixed;
      display: inline-block;
    }


    .messageheadercontain {
      height: 51px;
      border-bottom: 0.1px rgba(0, 0, 0, 0.3) solid;
    }

    .fa {
      margin-left: 20px;
      margin-right: 20px;
    }

    .fromsender {
      /* justify-content: center; */
      align-items: center;
      height: 45px;
      border-bottom: 0.1px rgba(0, 0, 0, 0.3) solid;
    }

    .img-icon {
      width: 30px;
      height: 30px;

    }



    .ul {
      /* align item to horizontal */
      display: block;
      justify-content: left;

    }

    .textarea {
      box-sizing: border-box;
      font-size: small;
      height: 60%;
      margin: 0;
      outline: none;
      overflow: auto;
      padding: 20px;
      word-break: break-word;
      overflow: hidden;
    }

    .bottom-btn {
      background: #fff;
      border-top: 1px solid #f5f2ee;
      box-sizing: border-box;
      flex-direction: row;
      justify-content: space-between;
      position: relative;
      width: 100%;
      align-items: center;
    }

    .btn {
      color: #fff;
      border-radius: 6px;
      font-family: LatoMedium, sans-serif;
      box-sizing: border-box;
      padding: 7px 20px 8px;
      box-shadow: 0 -2px 0 0 #0061ca inset;
      background-image: linear-gradient(to top, #0279ff, #00a3f3);
      font-size: 1.5rem;
      position: relative;
      border: 0;
      outline: 0;
      cursor: pointer;
      text-align: center;
      margin-right: 8px;
      font-size: medium;
    }

    hr {
      border: 0;
      border-top: 1px solid #eee;
      margin: 1px 0;
    }

    #message-templates:hover {
      background-color: #ddd;
    }

    #variable:hover {
      background-color: #ddd;
    }

    #message-templates {
      margin-block-start: 0em !important;
      margin-block-end: 0em !important;
      margin-inline-start: 0px;
      margin-inline-end: 0px;
    }
  </style>
</head>


<body>
  <p id="testing-work"></p>
  <div class="messageheadercontain">
    <span class="messageheader">
      <p>New Whatsapp Message</p>
    </span>
  </div>


  <div class="fromsender">
    <p><span style="font-weight: 700; padding-right: 30px;  align-items: center;">Send From:</span><span
        class="senderselect">Customer Support</span><i class="fa fa-caret-down" style="cursor: pointer;"
        onmouseover="senderselect()" onclick="senderselect()"></i><button style="float: right;"
        onclick="templateclick()">Select
        template</button></span> <button onclick="zohovariables()">Insert Variable</button></p>

  </div>



  <div class="textarea" contenteditable="true" onchange="keypress()">

  </div>



  <div class="bottom-btn"
    style="align-items: flex-end; justify-content: space-between; margin-top:  0.1px rgba(0, 0, 0, 0.3) solid;">
    <button style="float: right;" class="btn" onclick="sendmessage()">Send</button>
    <button style=" float: right; margin-right: 15px;" class="btn" onclick="savemessageastemplate()">save message as
      template</button>
  </div>


  <div id="id01" class="w3-modal">
    <div class="w3-modal-content">
      <div class="w3-container" style="height: 200px;">
        <span onclick="document.getElementById('id01').style.display='none'"
          class="w3-button w3-display-topright">&times;</span>
        <h3>Select Account</h4>
          <hr>
          <p onclick="sendfromwa1()" style="cursor: pointer;">Chatbot Account</p>
          <hr>
          <p onclick="sendfromwa2()" style="cursor: pointer;">Customer Support</p>
      </div>
    </div>
  </div>


  <div id="id02" class="w3-modal">
    <div class="w3-modal-content">
      <div class="w3-container" id="w3-container" style="min-height: 100px; max-height: 500px; overflow: scroll;">
        <span onclick="document.getElementById('id02').style.display='none'"
          class="w3-button w3-display-topright">&times;</span>
        <h4 style="font-weight: bold;" onclick="sendfromwa1()">Select Message Template</h4>
        <hr>
        <!-- <p style="cursor: pointer" onclick="sendfromwa2()">template 2</p>
        <p style="cursor: pointer" onclick="sendfromwa2()">template 3</p> -->
      </div>
    </div>
  </div>



  <div id="zoho-variables" class="w3-modal">
    <div class="w3-modal-content" style=" max-width: 200px;">
      <div class="w3-container " id="zohovar-container" style="min-height: 100px; max-height: 500px; overflow: scroll;">
        <span onclick="document.getElementById('zoho-variables').style.display='none'"
          class="w3-button w3-display-topright">&times;</span>
        <h4 onclick="zohovariables()">Select Variables</h4>
        <hr>
        <!-- <p style="cursor: pointer" id="variable"onclick="sendfromwa2()">Contact Name</p>
        <p style="cursor: pointer" id="variable"onclick="sendfromwa2()">Contact Age</p> -->
      </div>
    </div>
  </div>


  <script>

    var members_array = []
    function zohovariables() {
      var init_text = document.getElementById('zoho-variables').innerText
      // strip the white space from the text and remove the first character
      var init_text = init_text.replace(/\s/g, '').slice(1);
      console.log(init_text)
      // read and load the json object in the variables.json file


      var variables_array =   [{
    "name": "Owner name",
    "value": "${user.Owner.name}"
},  {
    "name": "Owner id",
    "value": "${user.Owner.id}"
},  {
    "name": "Owner email",
    "value": "${user.Owner.email}"
},  {
    "name": "Email",
    "value": "${user.Email}"
},  {
    "name": "$currency_symbol",
    "value": "${user.$currency_symbol}"
},  {
    "name": "$field_states", 
    "value": "${user.$field_states}"
},  {
    "name": "$photo_id",
    "value": "${user.$photo_id}"
},  {
    "name": "$review_process approve",
    "value": "${user.$review_process.approve}"
},  
{
    "name": "$review_process reject",
    "value": "${user.$review_process.reject}"
}, 
{
    "name": "$review_process resubmit",
    "value": "${user.$review_process.resubmit}"
}, 

{
    "name": "$canvas_id",
    "value": "${user.$canvas_id}"
},  {
    "name": "MB_Active_Date",
    "value": "${user.MB_Active_Date}"
},  {
    "name": "Name",
    "value": "${user.Name}"
},  {
    "name": "Last_Activity_Time",
    "value": "${user.Last_Activity_Time}"
},  {
    "name": "MB_Expiration_Date",
    "value": "${user.MB_Expiration_Date}"
},  {
    "name": "Record_Image",
    "value": "${user.Record_Image}"
},  {
    "name": "Modified_By name",
    "value": "${user.Modified_By.name}"
},  {
    "name": "Modified_By id",
    "value": "${user.Modified_By.id}"
},  {
    "name": "Modified_By email",
    "value": "${user.Modified_By.email}"
},  {
    "name": "$review",
    "value": "${user.$review}"
},  {
    "name": "MB_Client_Membership_ID",
    "value": "${user.MB_Client_Membership_ID}"
},  {
    "name": "MB_Count",
    "value": "${user.MB_Count}"
},  {
    "name": "MB_Payment_Date",
    "value": "${user.MB_Payment_Date}"
},  {
    "name": "$state",
    "value": "${user.$state}"
},  {
    "name": "Unsubscribed_Mode",
    "value": "${user.Unsubscribed_Mode}"
},  {
    "name": "$process_flow",
    "value": "${user.$process_flow}"
},  {
    "name": "MB_Program_Schedule_Type",
    "value": "${user.MB_Program_Schedule_Type}"
},  {
    "name": "MB_Membership_status",
    "value": "${user.MB_Membership_status}"
},  {
    "name": "MB_Program_ID",
    "value": "${user.MB_Program_ID}"
},  {
    "name": "id",
    "value": "${user.id}"
},  {
    "name": "MB_Client_ID",
    "value": "${user.MB_Client_ID}"
},  {
    "name": "MB_Remaining",
    "value": "${user.MB_Remaining}"
},  {
    "name": "$approved",
    "value": "${user.$approved}"
},  {
    "name": "$approval delegate",
    "value": "${user.$approval.delegate}"
},  {
    "name": "$approval approve",
    "value": "${user.$approval.approve}"
},  {
    "name": "$approval reject",
    "value": "${user.$approval.reject}"
},  {
    "name": "$approval resubmit",
    "value": "${user.$approval.resubmit}"
},  {
    "name": "Modified_Time",
    "value": "${user.Modified_Time}"
},  {
    "name": "Created_Time",
    "value": "${user.Created_Time}"
},  {
    "name": "Unsubscribed_Time",
    "value": "${user.Unsubscribed_Time}"
},  {
    "name": "$editable",
    "value": "${user.$editable}"
},  {
    "name": "Mobile",
    "value": "${user.Mobile}"
},  {
    "name": "$orchestration",
    "value": "${user.$orchestration}"
}, 
{
 "name":"Contact module",
    "value":"${user.Contact.module}"
},
 {
    "name": "Contact name",
    "value": "${user.Contact.name}"
},  {
    "name": "Contact id",
    "value": "${user.Contact.id}"
},  {
    "name": "MB_Program_Name",
    "value": "${user.MB_Program_Name}"
},  {
    "name": "MB_Membership_ID",
    "value": "${user.MB_Membership_ID}"
},  {
    "name": "Created_By name",
    "value": "${user.Created_By.name}"
},  {
    "name": "Created_By id",
    "value": "${user.Created_By.id}"
},  {
    "name": "Created_By email",
    "value": "${user.Created_By.email}"
},  {"name":"$approval_state",
    "value":"${user.$approval_state}"
}

 ]



      if (init_text == "SelectVariables") {
        //  for each element in array create an p with tag and append to element with id zoho-variables 
        variables_array.forEach(function (user) {
          var p = document.createElement("p");
          p.setAttribute("style", "cursor: pointer");
          p.setAttribute("onclick", "insertvariable('" + user.value + "')");
          p.id = "variable";
          p.innerHTML = user.name;
          var hr = document.createElement("hr");

          document.getElementById("zohovar-container").appendChild(hr);
          document.getElementById("zohovar-container").appendChild(p);

          p.onclick = function () {
            document.getElementsByClassName('textarea')[0].innerHTML += user.value;
          }

          // show the modal
          document.getElementById("zoho-variables").style.display = "block";

        });

      } else {
        document.getElementById('zoho-variables').style.display = 'block';
      }

    }


    function senderselect() {
      document.getElementById('id01').style.display = 'block';
    }

    function sendfromwa1() {
      document.getElementsByClassName('senderselect')[0].innerHTML = "Chatbot Account";
      document.getElementById('id01').style.display = 'none';

    }


    function sendfromwa2() {
      document.getElementsByClassName('senderselect')[0].innerHTML = "Customer Support";
      document.getElementById('id01').style.display = 'none';
    }


    // save message to template
    function savemessageastemplate() {
      var written_msg = document.getElementsByClassName('textarea')[0].innerText
      // remove white spaces at the end and beginning of written_msg


      if (written_msg == "") {
        alert("Message can not be empty")
      } else {
        var data = JSON.stringify({
          "message": written_msg
        });

        var config = {
          method: 'post',
          url: 'http://127.0.0.1:2001/savemessage',
          headers: {
            'Content-Type': 'application/json'
          },
          data: data
        };

        axios(config)
          .then(function (response) {
            console.log(JSON.stringify(response.data));
            alert(response.data)
          })
          .catch(function (error) {
            console.log(error);
          });


      }
    }

    // On CLick Send Button
    function sendmessage() {
      console.log("========= Member Array Logs Begins Here======")
      console.log(JSON.stringify(members_array, null, 2))
      console.log("========= Member Array Logs Ends Here======")
      var written_msg = document.getElementsByClassName('textarea')[0].innerText
      var selected_acc = document.getElementsByClassName('senderselect')[0].innerText
      var wa_url = "https://asanafinder.com:2000/sendmessage"
      if (selected_acc == "Chatbot Account") {
        var wa_url = "https://asanafinder.com:8080/sendmessage"
      }

      if (written_msg != "") {
        for (user of members_array) {
          console.log(user)
          //make the variables effect in the message
          var message = written_msg.replace(/\$\{user\.([^}]*)\}/g, function (match, p1) {
            console.log(match, p1)
            console.log(user[p1])
            return user[p1];
          });
          console.log(message)
          console.log(written_msg)


        }
        alert(`sending message ${written_msg}`)
      } else {
        alert("Message can not be empty")
      }
    }

    // On Template Select
    function templateclick() {
      // check if element with id message-template is present

      var init_text = document.getElementById('id02').innerText
      // strip the white space from the text and remove the first character
      var init_text = init_text.replace(/\s/g, '').slice(1);

      if (init_text == "SelectMessageTemplate") {

        var config = {
          method: 'get',
          url: 'http://127.0.0.1:2001/templates',
          headers: {}
        };

        axios(config)
          .then(function (response) {
            console.log(JSON.stringify(response.data))
            console.log(response.data)
            var array = response.data
            // for each element in array create an p with tag and append to element with id idol1 and prevent additional append
            array.forEach(function (element) {
              var p = document.createElement("p");
              // horizontal overflow to truncated


              p.style.cursor = "pointer";
              p.style.height = "50px";
              p.innerHTML = element;

              p.id = "message-templates";


              document.getElementById("w3-container").appendChild(p);
              // p on click add value from p to textarea
              p.onclick = function () {
                // replace  
                document.getElementsByClassName('textarea')[0].innerHTML = element;
              }


              var hr = document.createElement("hr");

              document.getElementById("w3-container").appendChild(hr);
              document.getElementById('id02').style.display = 'block';
            });


          })
          .catch(function (error) {
            console.log(error);
          });



      } else {
        document.getElementById('id02').style.display = 'block';
      }

    }

    ZOHO.embeddedApp.on("PageLoad", function (data) {
      console.log("Page Loaded with data");
      // console.log(data)

      const userids = data.EntityId

      for (userid of userids) {

        ZOHO.CRM.API.getRelatedRecords({ Entity: "MB_Memberships", RecordID: userid, page: 1, per_page: 200 })
          .then(function (response) {
            // console.log(response.data)
            var data = response.data[0]

            members_array.push(data)


          })

      }

    });


    ZOHO.embeddedApp.init()
  </script>
</body>

</html>